#+title: OCI CAPI cluster

Write a tfvars file

#+begin_src hcl
tenancy_ocid     = "TENANCY OCID"
user_ocid        = "YOUR USER OCID"
private_key_path = "YOUR PRIVATE KEY PATH"
fingerprint      = "THE FINGERPRINT FOR YOUR PRIVATE KEY"
region           = "us-sanjose-1"
compartment_ocid = "YOUR COMPARTMENT OCID"
#+end_src

Provision network resources

#+begin_src shell
tofu apply --var-file ./.tfvars
#+end_src

Bring up Kubernetes locally

#+begin_src bash
kind create cluster
#+end_src

#+begin_src bash :tangle .envrc
[ ! -f priv.env ] || . priv.env
# export OCI_TENANCY_ID=
# export OCI_USER_ID=
# export OCI_CREDENTIALS_FINGERPRINT=
# export OCI_CREDENTIALS_KEY_B64= # $(base64 < path/to/a/key.pem | tr -d '\n')
export OCI_REGION=us-sanjose-1

export OCI_TENANCY_ID_B64="$(echo -n "$OCI_TENANCY_ID" | base64 | tr -d '\n')"
export OCI_CREDENTIALS_FINGERPRINT_B64="$(echo -n "$OCI_CREDENTIALS_FINGERPRINT" | base64 | tr -d '\n')"
export OCI_USER_ID_B64="$(echo -n "$OCI_USER_ID" | base64 | tr -d '\n')"
export OCI_REGION_B64="$(echo -n "$OCI_REGION" | base64 | tr -d '\n')"

# if bootstraping from inside OCI
export USE_INSTANCE_PRINCIPAL="false"
export USE_INSTANCE_PRINCIPAL_B64="$(echo -n "$USE_INSTANCE_PRINCIPAL" | base64 | tr -d '\n')"
#+end_src

allow env from .envrc

#+begin_src bash
direnv allow
#+end_src

bootstrap capi with oci

#+begin_src bash
clusterctl init -b talos:v0.6.5 -c talos:v0.5.6 --infrastructure oci:v0.16.0
#+end_src

create a namespace

#+begin_src bash
kubectl create ns sharingio
#+end_src

#+RESULTS:
#+begin_src bash
namespace/sharingio created
#+end_src

Generate a cluster config

#+begin_src bash :tangle .envrc
# export OCI_COMPARTMENT_ID=
# export OCI_IMAGE_ID=ocid1.image.oc1.us-sanjose-1.aaaaaaaazpwpyk7kh6mbu2g6yihups2zf5uwt7moehbafxsu4idaew6nggxq # NOTE Oracle 8
export OCI_IMAGE_ID=ocid1.image.oc1.us-sanjose-1.aaaaaaaaqemyxu4dnhuapt6dfzuhq6rp5h3f7ld3yqh3crwiu5qtzlk6woma
export OCI_CONTROL_PLANE_MACHINE_TYPE=VM.Standard.A1.Flex
export OCI_CONTROL_PLANE_MACHINE_TYPE_OCPUS=4
export OCI_NODE_MACHINE_TYPE=VM.Standard.A1.Flex
export OCI_NODE_MACHINE_TYPE_OCPUS=8
export OCI_SSH_KEY=
export OCI_CONTROL_PLANE_PV_TRANSIT_ENCRYPTION=true
export OCI_NODE_PV_TRANSIT_ENCRYPTION=true

export TALOS_INSTALL_IMAGE=factory.talos.dev/installer/d01e4eb407f9a242831748cab07de55550fdcfe8be65ce4defd258a93d94562f:v1.7.6
export CLUSTER_NAME=sharingio
export CONTROL_PLANE_MACHINE_COUNT=3
export KUBERNETES_VERSION=v1.30.1
export NAMESPACE=sharingio
export POD_CIDR=192.168.0.0/16
export SERVICE_CIDR=10.128.0.0/12
export NODE_MACHINE_COUNT=6

export OCI_NETWORK_SECURITY_GROUP_ID="$(tofu output --raw oci_network_security_group_id || false)"
export OCI_NETWORK_SUBNET_ID="$(tofu output --raw oci_network_subnet_id)"
#+end_src

generate a cluster config

#+begin_src bash :epilogue ". .envrc ; \n"
clusterctl -n sharingio generate cluster "$CLUSTER_NAME" --from ./cluster-template.yaml --write-to ./cluster.yaml
#+end_src

#+RESULTS:
#+begin_example
#+end_example

apply the cluster

#+begin_src bash
kubectl -n sharingio apply -f ./cluster.yaml
#+end_src

#+RESULTS:
#+begin_example
cluster.cluster.x-k8s.io/sharingio created
ocicluster.infrastructure.cluster.x-k8s.io/sharingio created
taloscontrolplane.controlplane.cluster.x-k8s.io/sharingio-control-plane created
ocimachinetemplate.infrastructure.cluster.x-k8s.io/sharingio-control-plane created
ocimachinetemplate.infrastructure.cluster.x-k8s.io/sharingio-md-0 created
talosconfigtemplate.bootstrap.cluster.x-k8s.io/sharingio-md-0 created
machinedeployment.cluster.x-k8s.io/sharingio-md-0 created
#+end_example

view the world

#+begin_src shell
kubectl -n sharingio get $(kubectl -n sharingio api-resources | grep x-k8s | awk '{print $1}' | tr '\n' ',' | sed 's/,$//g')
#+end_src

#+RESULTS:
#+begin_example
NAME                                                                   AGE
talosconfig.bootstrap.cluster.x-k8s.io/sharingio-control-plane-54xzg   3m59s
talosconfig.bootstrap.cluster.x-k8s.io/sharingio-control-plane-pb4kn   3m59s
talosconfig.bootstrap.cluster.x-k8s.io/sharingio-control-plane-zzqh4   3m59s
talosconfig.bootstrap.cluster.x-k8s.io/sharingio-md-0-hbnp8-89rtk      4m55s
talosconfig.bootstrap.cluster.x-k8s.io/sharingio-md-0-hbnp8-9cj4h      4m55s
talosconfig.bootstrap.cluster.x-k8s.io/sharingio-md-0-hbnp8-cwjqj      4m55s
talosconfig.bootstrap.cluster.x-k8s.io/sharingio-md-0-hbnp8-k2q95      4m55s
talosconfig.bootstrap.cluster.x-k8s.io/sharingio-md-0-hbnp8-pwcpr      4m55s
talosconfig.bootstrap.cluster.x-k8s.io/sharingio-md-0-hbnp8-tf5sz      4m55s

NAME                                                            AGE
talosconfigtemplate.bootstrap.cluster.x-k8s.io/sharingio-md-0   4m55s

NAME                                 CLUSTERCLASS   PHASE         AGE     VERSION
cluster.cluster.x-k8s.io/sharingio                  Provisioned   4m56s

NAME                                                CLUSTER     REPLICAS   READY   UPDATED   UNAVAILABLE   PHASE       AGE     VERSION
machinedeployment.cluster.x-k8s.io/sharingio-md-0   sharingio   6                  6         6             ScalingUp   4m55s   v1.30.1

NAME                                                     CLUSTER     NODENAME   PROVIDERID                                                                                           PHASE         AGE     VERSION
machine.cluster.x-k8s.io/sharingio-control-plane-49xdq   sharingio              oci://ocid1.instance.oc1.us-sanjose-1.anzwuljr2lro64icvam6pkgfs2qtfkrtvwxubduivaq5lsx7s3wemcukihwq   Provisioned   3m59s   v1.30.1
machine.cluster.x-k8s.io/sharingio-control-plane-7vhcm   sharingio              oci://ocid1.instance.oc1.us-sanjose-1.anzwuljr2lro64icfmmfof6cpvas5pb6qnyz5pwc2afk4p3vnuxouwxwrmqa   Provisioned   3m59s   v1.30.1
machine.cluster.x-k8s.io/sharingio-control-plane-sdd4h   sharingio              oci://ocid1.instance.oc1.us-sanjose-1.anzwuljr2lro64iccmt7zj6sbj3ov7nmsi53demqdybwn7hp57gcohpokyuq   Provisioned   3m59s   v1.30.1
machine.cluster.x-k8s.io/sharingio-md-0-hbnp8-89rtk      sharingio                                                                                                                   Pending       4m55s   v1.30.1
machine.cluster.x-k8s.io/sharingio-md-0-hbnp8-9cj4h      sharingio                                                                                                                   Pending       4m55s   v1.30.1
machine.cluster.x-k8s.io/sharingio-md-0-hbnp8-cwjqj      sharingio                                                                                                                   Pending       4m55s   v1.30.1
machine.cluster.x-k8s.io/sharingio-md-0-hbnp8-k2q95      sharingio                                                                                                                   Pending       4m55s   v1.30.1
machine.cluster.x-k8s.io/sharingio-md-0-hbnp8-pwcpr      sharingio                                                                                                                   Pending       4m55s   v1.30.1
machine.cluster.x-k8s.io/sharingio-md-0-hbnp8-tf5sz      sharingio                                                                                                                   Pending       4m55s   v1.30.1

NAME                                               CLUSTER     REPLICAS   READY   AVAILABLE   AGE     VERSION
machineset.cluster.x-k8s.io/sharingio-md-0-hbnp8   sharingio   6                              4m55s   v1.30.1

NAME                                                                      READY   INITIALIZED   REPLICAS   READY REPLICAS   UNAVAILABLE REPLICAS
taloscontrolplane.controlplane.cluster.x-k8s.io/sharingio-control-plane                         3                           3

NAME                                                   AGE
ocicluster.infrastructure.cluster.x-k8s.io/sharingio   4m56s

NAME                                                                       AGE
ocimachine.infrastructure.cluster.x-k8s.io/sharingio-control-plane-95b4h   3m59s
ocimachine.infrastructure.cluster.x-k8s.io/sharingio-control-plane-968kw   3m59s
ocimachine.infrastructure.cluster.x-k8s.io/sharingio-control-plane-fjxgw   3m59s
ocimachine.infrastructure.cluster.x-k8s.io/sharingio-md-0-hbnp8-89rtk      4m55s
ocimachine.infrastructure.cluster.x-k8s.io/sharingio-md-0-hbnp8-9cj4h      4m55s
ocimachine.infrastructure.cluster.x-k8s.io/sharingio-md-0-hbnp8-cwjqj      4m55s
ocimachine.infrastructure.cluster.x-k8s.io/sharingio-md-0-hbnp8-k2q95      4m55s
ocimachine.infrastructure.cluster.x-k8s.io/sharingio-md-0-hbnp8-pwcpr      4m55s
ocimachine.infrastructure.cluster.x-k8s.io/sharingio-md-0-hbnp8-tf5sz      4m55s

NAME                                                                         AGE
ocimachinetemplate.infrastructure.cluster.x-k8s.io/sharingio-control-plane   4m56s
ocimachinetemplate.infrastructure.cluster.x-k8s.io/sharingio-md-0            4m55s
#+end_example

Tear down

#+begin_src shell
kubectl -n sharingio delete -f ./cluster.yaml 2>&1
#+end_src

#+RESULTS:
#+begin_example
Error from server (NotFound): error when deleting "./cluster.yaml": clusters.cluster.x-k8s.io "sharingio" not found
Error from server (NotFound): error when deleting "./cluster.yaml": ociclusters.infrastructure.cluster.x-k8s.io "sharingio" not found
Error from server (NotFound): error when deleting "./cluster.yaml": taloscontrolplanes.controlplane.cluster.x-k8s.io "sharingio-control-plane" not found
Error from server (NotFound): error when deleting "./cluster.yaml": ocimachinetemplates.infrastructure.cluster.x-k8s.io "sharingio-control-plane" not found
Error from server (NotFound): error when deleting "./cluster.yaml": ocimachinetemplates.infrastructure.cluster.x-k8s.io "sharingio-md-0" not found
Error from server (NotFound): error when deleting "./cluster.yaml": talosconfigtemplates.bootstrap.cluster.x-k8s.io "sharingio-md-0" not found
Error from server (NotFound): error when deleting "./cluster.yaml": machinedeployments.cluster.x-k8s.io "sharingio-md-0" not found
#+end_example
