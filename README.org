#+title: infra

#+begin_quote
a Flux + Terraform infrastructure repo
#+end_quote

* Prerequisites

Install OpenTofu

#+begin_src tmux :session ":tofu "
brew install opentofu oci-cli
#+end_src

#+RESULTS:

Create a .tfvars file

#+begin_src hcl
tenancy_ocid     = "TENANCY OCID                         : https://cloud.oracle.com/tenancy"
user_ocid        = "YOUR USER OCID                       : https://cloud.oracle.com/identity/domains/my-profile"
private_key_path = "YOUR PRIVATE KEY PATH                : https://cloud.oracle.com/identity/domains/my-profile/api-keys"
fingerprint      = "THE FINGERPRINT FOR YOUR PRIVATE KEY : ^^"
region           = "us-sanjose-1"
compartment_ocid = "YOUR COMPARTMENT OCID                : https://cloud.oracle.com/identity/compartments # cloudnative.coop"
#+end_src

Log into ~oci-cli~, using the links provided in the hcl file above to get keys and other data.

#+begin_src shell
oci setup bootstrap
#+end_src

A kubeconfig must be at =~/.kube/config-fop= for using shared tfstate.

* Usage

init

#+begin_src shell
tofu init --var-file=./.tfvars
#+end_src


plan

#+begin_src tmux :session ":tofu"
tofu plan --var-file=./.tfvars
#+end_src

apply

#+begin_src tmux :session ":tofu"
tofu apply --var-file=./.tfvars
#+end_src

get kubeconfig

#+begin_src tmux
mkdir -p ~/.kube
tofu output -raw cluster-sharingio-oke-kubeconfig > ~/.kube/config
#+end_src

* Force tear down

#+begin_src tmux :session ":tofu"
tofu state list | grep -E 'talos|flux|manifests|kubernetes_manifest' | xargs -I{} tofu state rm {}
tofu destroy -var-file=./.tfvars
#+end_src
